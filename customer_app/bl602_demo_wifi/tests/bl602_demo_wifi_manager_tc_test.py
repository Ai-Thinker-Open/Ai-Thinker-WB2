from __future__ import print_function
from __future__ import unicode_literals
import time
import re
import subprocess
import os

from tiny_test_fw import DUT, App, TinyFW
from ttfw_bl import BL602App, BL602DUT


@TinyFW.test_method(app=BL602App.BL602App, dut=BL602DUT.BL602TyMbDUT, test_suite_name='bl602_demo_wifi_manager_tc')
def bl602_demo_wifi_manager_tc(env, extra_data):
    # first, flash dut
    # then, test
    dut = env.get_dut("port0", "fake app path")
    print('Flashing app')
    dut.flash_app(env.log_path, env.get_variable('flash'))
    print('Starting app')
    dut.start_app()

    try:
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 booted')
        dut.expect('Init CLI with event Driven', timeout=0.5)
        print('BL602 CLI init done')
        time.sleep(1)

        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect wobucunzai 12345678')
        dut.expect("Reason: SSID error, scan no bssid and channel", timeout=10)
        print('case1:SSID error test successed')
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        bssid = os.getenv('TEST_ROUTER_SSID')
        cmd = ("wifi_sta_connect", bssid, "123456789")
        cmd_wifi_connect = ' '.join(cmd)
        dut.write(cmd_wifi_connect)
        dut.expect("Reason: Passwd error, 4-way handshake timeout", timeout=20)
        print('case2:Passwd error test successed')
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        bssid = os.getenv('TEST_ROUTER_SSID_CLOSED')
        pwd = os.getenv('TEST_ROUTER_PASSWORD_CLOSED')
        cmd = ("wifi_sta_connect", bssid, pwd)
        cmd_wifi_connect = ' '.join(cmd)
        dut.write(cmd_wifi_connect)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case3:connect wifi test successed')
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_AES 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case4:connect LEDE_WPA_WPA2_AES successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_TKIP 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case5:connect LEDE_WPA_WPA2_TKIP successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_MIX 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case6:connect LEDE_WPA_WPA2_MIX successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_MIX_MFPFORCE 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case7:connect LEDE_WPA_WPA2_MIX_MFPFORCE successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_AES_MFPFORCE 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case8:connect LEDE_WPA_WPA2_AES_MFPFORCE successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_AES_MFPOPT 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case9:connect LEDE_WPA_WPA2_AES_MFPOPT successed, IP is %s' %ip)
               
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_WPA2_MIX_MFPOPT 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case10:connect LEDE_WPA_WPA2_MIX_MFPOPT successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_OPEN')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case11:connect LEDE_OPEN successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WEP_OPEN 12345')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case12:connect LEDE_WEP_OPEN successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WEP_SHARED 12345')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case13:connect LEDE_WEP_SHARED successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_TKIP 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case14:connect LEDE_WPA_TKIP successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_AES 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case15:connect LEDE_WPA_AES successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA_MIX 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case16:connect LEDE_WPA_MIX successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_TKIP 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case17:connect LEDE_WPA2_TKIP successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_AES 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case18:connect LEDE_WPA2_AES successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_MIX 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case19:connect LEDE_WPA2_MIX successed, IP is %s' %ip)
               
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_AES_MFPFORCE 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case20:connect LEDE_WPA2_AES_MFPFORCE successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_MIX_MFPFORCE 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case21:connect LEDE_WPA2_MIX_MFPFORCE successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_AES_MFPOPT 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        print('case22:connect LEDE_WPA2_AES_MFPOPT successed, IP is %s' %ip)
        
        print('To reboot BL602')
        dut.write('reboot')
        dut.expect("Booting BL602 Chip...", timeout=0.5)
        print('BL602 rebooted')
        time.sleep(0.5)
        dut.write('stack_wifi')
        time.sleep(0.5)
        dut.write('wifi_sta_connect LEDE_WPA2_MIX_MFPOPT 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)
        dut.expect("wifiConnected_IPOK", timeout=20)
        dut.write('wifi_sta_disconnect')
        time.sleep(2)
        dut.write('wifi_sta_connect LEDE_WPA2_MIX_MFPOPT 12345678')
        ip = dut.expect(re.compile(r"IP: (\S+)"), timeout=30)       
        print('case23:connect LEDE_WPA2_MIX_MFPOPT successed, IP is %s' %ip)
        print('case24:connect disconnect connect test successed')
        
        
        
        #cmd = "ssh xiaohei@192.168.4.145 'cd /home/xiaohei/PycharmProjects/router_auto_test/ ; python3 test.py close_wifi'"
        #subprocess.call(cmd, shell=True)
        #dut.expect("Reason: Beacon Loss", timeout=20)
        dut.halt()

    except Exception:
        dut.write('p 0')
        dut.expect("sky", timeout=10)
        print('ENV_TEST_FAILURE: BL602 wifi manager test failed')
        raise

if __name__ == '__main__':
    bl602_demo_wifi_manager_tc()
